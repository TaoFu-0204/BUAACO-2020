# P7思路

考虑到出错可能在IF级（取指错误）、ID（错误指令）、EX（计算溢出）、Mem（存取异常）级产生，流水线寄存器中应加入错误信号的流水，同时考虑如存取数的溢出错误产生于EX，但应归类于Mem类这样的情况。最终在Mem阶段检查有无错误信号，若有错误信号则取消任何向DM和GRF的写入操作（DMEn置零，RegWriteAddr置零）。

例外：乘除相关指令会产生错误吗？

在Mem阶段若检测到错误信号有效，则将错误信息发送给CP0，通知进入错误处理程序。

* 如何通知进入错误处理？

另外需要考虑中断情况。若产生中断，有以下问题：

* 流水线中哪一级正在执行的指令应被当作是受害指令？
  * 注意中断的受害指令和错误的受害指令不同，错误的受害指令要扔掉，中断的受害指令相当于中断插入在本条指令之前，要将它保存起来以待后续执行。
  * 解决机制：选择EPC存入PC+4还是当前PC。
  * 站在评测系统的角度，我如何插入中断能保证随机性最小？
    * 本次顶层模块加入了宏观PC这一输出，相当于“当前还没有执行完的指令”。
    * 考虑到指令的执行结果实际上会在EX（mult）、Mem（sw）和WB（其它寄存器相关）阶段动存储相关元件，由于我们实际上不知道当前指令及其后续/前序指令执行情况，我们应该跟踪EX阶段的指令地址，这样可以保证当前指令一定没被执行完。
    * 那么我们的异常处理就应该清空IF/ID、ID/EX两级流水线寄存器，但不动后面的寄存器，让已经过了的指令执行结束。同时改PC的值，让它接下来从异常处理模块读指令。

